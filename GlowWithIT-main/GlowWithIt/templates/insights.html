{# templates/insights.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}GlowWithIT — Melbourne's Night Safety Data Story{% endblock %}

{% block content %}

<!--This insights.html is for displaying all data visuals with key insights that users can easily follow and explore -->

<div class="story">

  <div id="top-of-story" style="position:relative; top:-12px;"></div>

  <!-- Chapter 1: Understanding the Challenge -->
  <section class="chapter bg-1">
    <div class="wrap">
      <div class="center">
        <span class="tag">
          <span class="dot-1"></span>
          <span class="">Understanding the Challenge</span>
        </span>
        <h1 class="story-title mt-3">Melbourne's Night Safety Story</h1>
        <p class="lead mt-3 mb-3">
          Every number tells a human story. Behind Melbourne’s night-time statistics, there are night workers,
          women traveling home, and essential service providers who deserve safe journeys. These are the insights that
          drive our mission to create safer streets.
        </p>
      </div>

      <section class="stat-panel mb-64 mt-5">
        <div class="stat-grid-2">
          <div class="media-col">
            <figure class="stat-banner-1-media">
              <img src="{% static 'images/night-worker.jpg' %}" alt="Night worker in Melbourne" />
            </figure>
          </div>

          <div>
            <div class="stat-lg">22%</div>
            <h3 class="stat-h3 mb-12">of Melbourne's workforce operates during night hours</h3>
            <p class="stat-body mb-24">
              <span class="msg-source">According to <cite>University of Melbourne’s Night Shift Report (2024)</cite></span>,
              that’s over <strong class="stat-text-for-strong">320,000</strong> people keeping the city running while most sleep.
              They face unique safety challenges that deserve attention and support.
            </p>

            <div class="stat-bars">
              <div class="stat-bar-row"></div>
            </div>
          </div>

        </div>
      </section>

      <section class="stat-panel mb-64 mt-5">
        <div class="stat-grid-2">
          <div>
            <div class="stat-lg">58%</div>
            <h3 class="stat-h3 mb-12">of night workers are women</h3>
            <p class="stat-body mb-24">
              Women make up the majority of Melbourne's night workforce, particularly in healthcare,
              hospitality, and customer service roles. Yet when the shift ends,
              many face <strong class="stat-text-for-strong">heightened safety risks</strong> just getting home.
            </p>

            <div class="stat-bars">
              <div class="stat-bar-row">
                <span>Healthcare &amp; Social Assistance</span>
                <div class="stat-bar"><span class="stat-bar-fill" style="width:80%"></span></div>
                <span class="stat-bar-val">80%</span>
              </div>
              <div class="stat-bar-row">
                <span>Accommodation &amp; Food Services</span>
                <div class="stat-bar"><span class="stat-bar-fill" style="width:60%"></span></div>
                <span class="stat-bar-val">60%</span>
              </div>
              <div class="stat-bar-row">
                <span>Retail Trade</span>
                <div class="stat-bar"><span class="stat-bar-fill" style="width:50%"></span></div>
                <span class="stat-bar-val">50%</span>
              </div>
            </div>
          </div>

          <div>
            <div class="stat-tiles">
              <div class="stat-tile">
                <i class="bi bi-hospital stat-ic-lg" aria-hidden="true"></i>
                <div class="stat-tile-num">89,000</div><div class="stat-tile-sub">Healthcare Workers</div>
              </div>
              <div class="stat-tile">
                <svg class="stat-ic-lg" viewBox="0 0 24 24" aria-hidden="true" fill="none"><path d="M4 3v9M8 3v9M6 3v9M14 3h3a3 3 0 0 1 3 3v6M14 21v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                <div class="stat-tile-num">76,000</div><div class="stat-tile-sub">Hospitality Staff</div>
              </div>
              <div class="stat-tile">
                <svg class="stat-ic-lg" viewBox="0 0 24 24" aria-hidden="true" fill="none"><rect x="4" y="3" width="16" height="13" rx="3" stroke="currentColor" stroke-width="2"/><path d="M4 8h16M7 20h2M15 20h2M6 16h.01M18 16h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                <div class="stat-tile-num">52,000</div><div class="stat-tile-sub">Transport Workers</div>
              </div>
              <div class="stat-tile">
                <svg class="stat-ic-lg" viewBox="0 0 24 24" aria-hidden="true" fill="none"><circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2"/><path d="M6 21a6 6 0 0 1 12 0" stroke="currentColor" stroke-width="2"/><path d="M21 11l-2 2-1-1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <div class="stat-tile-num">41,000</div><div class="stat-tile-sub">Security Staff</div>
              </div>
            </div>
          </div>
        </div>
      </section>

    </div>
  </section>

  <!-- Chapter 2: Current Reality -->
  <section class="chapter bg-2" id="age-safety">
    <div class="wrap">
      <div class="center">
        <span class="tag">
          <span class="dot-2"></span>
          <span>Current Reality</span>
        </span>
        <h2 class="story-title mt-3">How Safe Do People Actually Feel?</h2>
        &nbsp;
        <p class="lead">Understanding perception is crucial. Age, experience,
          and personal circumstances all influence how safe someone feels traveling at night in Melbourne.</p>
      </div>

      <!--insight flippable flash cards -->
      <section class="insight-deck mt-5">
        <div class="insight-grid mt-5">

          <!-- Card 1 -->
          <article class="flip-card stat-box insight-card" data-flip-card aria-expanded="false">
            <div class="flip-inner">
              <div class="flip-face flip-front">
                <div class="media">
                  <img src="{% static 'images/feel-unsade-flip-card1.jpg' %}" alt="Women travelling at night in Melbourne" loading="lazy" decoding="async">
                </div>
                <div class="scrim" aria-hidden="true"></div>
                <div class="overlay">
                  <span class="chip"><span class="dot-2"></span> SAFETY INSIGHT</span>
                  <h4 class="title">Women who feel safe after 10pm</h4>
                  <div class="stat">
                    <span class="val" aria-label="sixty two percent">62%</span>
                    <span class="delta up" aria-label="up four percent">▲ 4%</span>
                  </div>
                  <button type="button" class="flip-btn flip-toggle" aria-expanded="false" aria-controls="card1-back">Flip for details</button>
                </div>
              </div>
              <div class="flip-face flip-back" id="card1-back" tabindex="-1">
                <h4 class="stat-h4 mb-1">Details</h4>
                <ul class="stat-list mt-2">
                  <li><span class="stat-dot"></span><span class="stat-body">Measure: % “Very/Somewhat safe”.</span></li>
                  <li><span class="stat-dot"></span><span class="stat-body">Source: CoMSIS 2023.</span></li>
                  <li><span class="stat-dot"></span><span class="stat-body">Confidence: High (n=1,238).</span></li>
                </ul>
                <button type="button" class="btn btn-outline-light btn-sm flip-toggle" aria-expanded="true" aria-controls="card1-back">Flip back</button>
              </div>
            </div>
          </article>

          <!-- Card 2 -->
          <article class="flip-card stat-box insight-card" data-flip-card aria-expanded="false">
            <div class="flip-inner">
              <div class="flip-face flip-front">
                <div class="media">
                  <img src="{% static 'images/flip-card-2.jpg' %}" alt="Night workforce illustration" loading="lazy" decoding="async">
                </div>
                <div class="scrim" aria-hidden="true"></div>
                <div class="overlay">
                  <span class="chip"><span class="dot-1"></span> WORKFORCE</span>
                  <h4 class="title">Night workforce share</h4>
                  <div class="stat"><span class="val">22%</span></div>
                  <button type="button" class="flip-btn flip-toggle" aria-expanded="false" aria-controls="card2-back">Flip for details</button>
                </div>
              </div>
              <div class="flip-face flip-back" id="card2-back" tabindex="-1">
                <h4 class="stat-h4 mb-1">Details</h4>
                <ul class="stat-list mt-2">
                  <li><span class="stat-dot"></span><span class="stat-body">≈ 320,000 people working nights.</span></li>
                  <li><span class="stat-dot"></span><span class="stat-body">Source: UniMelb Night Shift Report (2024).</span></li>
                </ul>
                <button type="button" class="btn btn-outline-light btn-sm flip-toggle" aria-expanded="true" aria-controls="card2-back">Flip back</button>
              </div>
            </div>
          </article>

          <!-- Card 3 -->
          <article class="flip-card stat-box insight-card" data-flip-card aria-expanded="false">
            <div class="flip-inner">
              <div class="flip-face flip-front">
                <div class="media">
                  <img src="{% static 'images/flip-card-3.jpg' %}" alt="Young adults travelling at night" loading="lazy" decoding="async">
                </div>
                <div class="scrim" aria-hidden="true"></div>
                <div class="overlay">
                  <span class="chip"><span class="dot-2"></span> AGE GROUP</span>
                  <h4 class="title">Youngest group feels least safe</h4>
                  <div class="stat"><span class="val">52.3%</span></div>
                  <button type="button" class="flip-btn flip-toggle" aria-expanded="false" aria-controls="card3-back">Flip for details</button>
                </div>
              </div>
              <div class="flip-face flip-back" id="card3-back" tabindex="-1">
                <h4 class="stat-h4 mb-1">Details</h4>
                <ul class="stat-list mt-2">
                  <li><span class="stat-dot"></span><span class="stat-body">18–24s report lowest perceived safety.</span></li>
                  <li><span class="stat-dot"></span><span class="stat-body">Gap vs 65+: 24.6 pp.</span></li>
                </ul>
                <button type="button" class="btn btn-outline-light btn-sm flip-toggle" aria-expanded="true" aria-controls="card3-back">Flip back</button>
              </div>
            </div>
          </article>

        </div>
      </section>

    </div>
  </section>

  <section id="gw-heatmap-chartjs" class="chapter bg-4">
    <div class="wrap">
      <div class="center">
        <h2 class="story-title mt-3">Crime Patterns &amp; Geographic Analysis</h2>
        &nbsp;
        <p class=" mt-3 lead">
          Location matters. Understanding where and when safety incidents occur helps us design
          smarter routes and deploy resources more effectively.
        </p>
      </div>

      <!--conclusion-->
      <div class="kpi-grid mt-5">
        <div class="kpi kpi-total">
          Total Incidents: <strong id="ev-total"></strong>
        </div>
        <div class="kpi kpi-male">
          <i class="bi bi-person-standing" aria-hidden="true"></i>
          Male: <strong id="ev-male"></strong>
        </div>
        <div class="kpi kpi-female">
          <i class="bi bi-person-standing-dress" aria-hidden="true"></i>
          Female: <strong id="ev-female"></strong>
        </div>
      </div>

      <!--Display the crime heat matrix and related key insight (takeaway) section-->
      <div class="crime-split mt-3">
        <!--Crime Heatmap-->
        <div class="crime-heatmap-container">
          <!--chart will be loaded by EChart.js-->
          <div id="crimeHeatmapEC" class="crimeHeatmapStat"></div>
          <div class="crimeHeatMapText">
            Source: Crime Statistic Agency - Latest Data By Area
          </div>
        </div>

        <!-- Key Insights beside the heatmap -->
        <aside class="stat-box" style="height:100%;">
          <h4 id="crime-insights-h" class="stat-h4 mb-12">Key Insights</h4>
          <ul class="stat-list">
            <li>
              <span class="stat-dot"></span>
              <span class="stat-body"><strong class="stat-text-for-strong">West Melbourne</strong> records the <strong class="stat-text-for-strong">highest</strong> incident levels.</span>
            </li>
            <li>
              <span class="stat-dot"></span>
              <span class="stat-body"><strong class="stat-text-for-strong">Males</strong> make up the clear majority in every region.</span>
            </li>
            <li>
              <span class="stat-dot"></span>
              <span class="stat-body">Large regional gap → focus resources where counts are highest.</span>
            </li>
          </ul>

          <div class="hint" style="margin-top:12px;">
            <i class="bi bi-lightbulb-fill" aria-hidden="true"></i>
            <div><strong>Takeaway:</strong> Prioritise West & Central Melbourne and tailor measures to male offending patterns.</div>
          </div>
        </aside>
      </div>
    </div>
  </section>

  <!-- Section 3: Taking Action -->
  <section class="chapter bg-3">
    <div class="wrap">
      <div class="center">
        <span class="tag">
          <span class="dot-3"></span>
          <span>Taking Action</span>
        </span>
        <h2 class="story-title mt-3">Melbourne’s Safety Investment Response</h2>
        <p class="lead mt-3">City Council will spend <strong class="stat-text-for-strong">$2.1 million</strong> to add <strong class="stat-text-for-strong">100+</strong> cameras to the <strong class="stat-text-for-strong">Safe City Cameras Program</strong>. </p>
        <p class="lead mt-3">
          The goal is simple: safer streets, stronger support, and peace of mind for the people who keep our city running.
        </p>
      </div>

      <div class="stat-tiles" style="margin-top:24px;">
        <!--CCTV-->
        <div class="stat-tile">
          <div class="stat-tile-num">+100</div>
          <div class="stat-tile-sub">New CCTV cameras</div>
        </div>

        <!--Lighting Budget-->
        <div class="stat-tile">
          <div class="stat-tile-num">+ $1 million budget</div>
          <div class="stat-tile-sub">Lighting improvements</div>
        </div>

        <!--Graffiti Removal-->
        <div class="stat-tile">
          <div class="stat-tile-num">-130,000m²</div>
          <div class="stat-tile-sub">Graffiti Removal</div>
        </div>

        <!--Victoria Police Partnership-->
        <div class="stat-tile">
          <div class="stat-tile-num">+Ongoing</div>
          <div class="stat-tile-sub">Victoria Police Surveillance</div>
        </div>
      </div>
    </div>
  </section>


  <!-- Community Awareness -->
<section class="chapter bg-2 awareness" id="awareness">
  <div class="wrap">
    <div class="center">
      <span class="tag"><span class="dot-2"></span><span>Community Awareness</span></span>
      <h2 class="story-title mt-3">Gender Safety Awareness</h2>
      <p class="lead mt-3">
        Real stats from ABS, PTV and Victoria Police show how risks change and where support is available.
        Use the dropdowns to view a single, focused chart. Every insight links to its source.
      </p>
    </div>

    <!-- dropdowns visuals -->
    <div class="controls">
      <label for="sourceFilter" class="fw-semibold">Source:</label>
      <select id="sourceFilter" class="select-glass">
        <option value="abs" selected>ABS / AIHW</option>
        <option value="stopit">Victoria Police — STOPIT</option>
        <option value="ptv">PTV — Night Network</option>
        <option value="city">City of Melbourne — Budget/Lighting</option>
      </select>

      <label for="vizFilter" class="fw-semibold">Chart:</label>
      <select id="vizFilter" class="select-glass">
        <!-- options populated dynamically -->
      </select>
    </div>

    <section class="section-wrap">
      <div class="container">

        <!-- ABS group -->
        <section class="stat-panel mt-2 viz-block"
                 data-group="abs" data-key="avoid" data-label="Feelings of safety: avoidance (night walk)">
          <div class="stat-grid-2">
            <div class="chart-col">
              <div class="fact-card">
                <div class="chip-row"><span class="chip"><span class="dot"></span> VIC</span><span class="chip">ABS PSS • 2021–22</span></div>
                <div id="chartAvoidNight" class="chart-frame"></div>
                <div class="stat-source">ABS — Feeling safe (PSS 2021–22)</div>
              </div>
            </div>
            <aside class="narration-cloud">
              <div class="stat-lg">63%</div>
              <div class="stat-h3">Women avoid walking alone after dark</div>
              <p class="stat-body">Men: 31%. Lighting & presence reduce avoidance.</p>
            </aside>
          </div>
        </section>

        <section class="stat-panel mt-4 viz-block"
                 data-group="abs" data-key="harass" data-label="Sexual harassment (12 months)">
          <div class="stat-grid-2 flip">
            <aside class="narration-cloud">
              <div class="stat-lg">13%</div>
              <div class="stat-h3">Women reported sexual harassment (12 months)</div>
              <p class="stat-body">Men: 4.5%. Clear reporting & bystander tips matter.</p>
            </aside>
            <div class="chart-col">
              <div class="fact-card">
                <div class="chip-row"><span class="chip"><span class="dot"></span> AUS</span><span class="chip">ABS PSS • 2021–22</span></div>
                <div id="chartSexHarass" class="chart-frame"></div>
                <div class="stat-source">ABS — Sexual harassment (2021–22)</div>
              </div>
            </div>
          </div>
        </section>

        <section class="stat-panel mt-4 viz-block"
                 data-group="abs" data-key="stalking" data-label="Lifetime stalking">
          <div class="stat-grid-2">
            <div class="chart-col">
              <div class="fact-card">
                <div class="chip-row"><span class="chip"><span class="dot"></span> AUS</span><span class="chip">ABS Media • Oct 2024</span></div>
                <div id="chartStalking" class="chart-frame"></div>
                <div class="stat-source">ABS — Stalking (media release, 16 Oct 2024)</div>
              </div>
            </div>
            <aside class="narration-cloud">
              <div class="stat-lg">1 in 5</div>
              <div class="stat-h3">Women have been stalked since age 15</div>
              <p class="stat-body">Men: 1 in 15 (~2.7m adults stalked).</p>
            </aside>
          </div>
        </section>

        <section class="stat-panel mt-4 viz-block"
                 data-group="abs" data-key="ipv" data-label="Intimate partner violence (lifetime)">
          <div class="stat-grid-2 flip">
            <aside class="narration-cloud">
              <div class="stat-lg">1 in 4</div>
              <div class="stat-h3">Women have experienced partner violence since 15</div>
              <p class="stat-body">Men: 1 in 14 (7.3%).</p>
            </aside>
            <div class="chart-col">
              <div class="fact-card">
                <div class="chip-row"><span class="chip"><span class="dot"></span> AUS</span><span class="chip">AIHW from ABS PSS</span></div>
                <div id="chartIPV" class="chart-frame"></div>
                <div class="stat-source">AIHW (from ABS PSS)</div>
              </div>
            </div>
          </div>
        </section>

        <section class="stat-panel mt-4 viz-block"
                 data-group="abs" data-key="vic-safe" data-label="VIC: feel safe walking alone at night">
          <div class="stat-grid-2">
            <div class="chart-col">
              <div class="fact-card">
                <div class="chip-row"><span class="chip"><span class="dot"></span> VIC</span><span class="chip">VicHealth • 2015</span></div>
                <div id="chartVicNightSafe" class="chart-frame"></div>
                <div class="stat-source">VicHealth Indicators via Women’s Health Atlas</div>
              </div>
            </div>
            <aside class="narration-cloud">
              <div class="stat-lg">44%</div>
              <div class="stat-h3">Women feel safe walking alone at night (Victoria)</div>
              <p class="stat-body">Men: 78.8%. Lighting & presence matter.</p>
            </aside>
          </div>
        </section>

        <!-- STOPIT group -->
        <section class="stat-panel mt-4 viz-block"
                 data-group="stopit" data-key="overview" data-label="STOPIT overview">
          <div class="stat-grid-2">
            <div class="chart-col">
              <div class="fact-card">
                <div class="chip-row"><span class="chip"><span class="dot"></span> VIC</span><span class="chip">Vic Police • 2022–24</span></div>
                <div id="chartSTOPIT" class="chart-frame"></div>
                <div class="stat-source">ABC News (10 Jul 2024) / Victoria Police</div>
              </div>
            </div>
            <aside class="narration-cloud">
              <div class="stat-lg">STOPIT</div>
              <div class="stat-h3">Report anonymously on public transport</div>
              <p class="stat-body">3,000 reports • 60 investigations • 33 charged (first two years).</p>
            </aside>
          </div>
        </section>

        <!-- PTV group -->
        <section class="stat-panel mt-4 viz-block"
                 data-group="ptv" data-key="night-network" data-label="Night Network coverage">
          <div class="stat-grid-2 flip">
            <aside class="narration-cloud">
              <div class="stat-lg">24-hour PT</div>
              <div class="stat-h3">All-night services on Friday & Saturday</div>
              <p class="stat-body">Useful for night shifters: 2 of 7 nights run 24-hour services.</p>
            </aside>
            <div class="chart-col">
              <div class="fact-card">
                <div class="chip-row"><span class="chip"><span class="dot"></span> MELBOURNE</span><span class="chip">PTV • current</span></div>
                <div id="chartNightNetwork" class="chart-frame"></div>
                <div class="stat-source">PTV — Night Network</div>
              </div>
            </div>
          </div>
        </section>

        <!-- City group -->
        <section class="stat-panel mt-4 viz-block"
                 data-group="city" data-key="budget" data-label="Budget & lighting">
          <div class="stat-grid-2">
            <div class="chart-col">
              <div class="fact-card">
                <div class="chip-row"><span class="chip"><span class="dot"></span> CoM</span><span class="chip">Budget • 2025–26</span></div>
                <div id="chartBudget" class="chart-frame"></div>
                <div class="stat-source">City of Melbourne & ABC News (2025)</div>
              </div>
            </div>
            <aside class="narration-cloud">
              <div class="stat-lg">$14m</div>
              <div class="stat-h3">Record safety investment (2025–26)</div>
              <p class="stat-body">100+ new CCTV; +$4.5m vs last year.</p>
            </aside>
          </div>
        </section>

      </div>
    </section>
  </div>
</section>


  <!-- Future Data Plan -->
  <section class="chapter bg-5">
    <div class="wrap">
      <div class="center">
        <span class="tag">
          <span class="dot-5"></span>
          <span>The Story Continues</span>
        </span>

        <h1 class="story-title mt-3">Melbourne's Night Safety Story</h1>

        <p class="lead mt-3 mb-3">
          This data story isn't just about numbers— it's about creating real change.
          Every insight enlightens us to provide
          <strong class="stat-text-for-strong">safer, smarter routes</strong>
          for Melbourne's night community.
        </p>
        &nbsp;

        <!--Scroll the page to the top-->
        <a href="#top-of-story" class="btn btn-warning fw-bold mt-3">↑ Back to top</a>
      </div>
    </div>
  </section>

</div>



<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@3.0.1/dist/chartjs-chart-matrix.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js" defer></script>
<script type="module" src="{% static 'js/insight.js' %}" defer></script>
<script type="module" src="{% static 'js/awareness.js' %}" defer></script>


<script>
(function(){
  function toggleCard(btn){
    const card = btn.closest('[data-flip-card]');
    if(!card) return;
    const inner = card.querySelector('.flip-inner');
    const expanded = card.getAttribute('aria-expanded') === 'true';
    const next = !expanded;

    // Update state
    card.setAttribute('aria-expanded', String(next));
    // Sync all toggle buttons inside the same card
    card.querySelectorAll('.flip-toggle').forEach(b => b.setAttribute('aria-expanded', String(next)));

    // For motion-enabled users, do 3D flip
    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if(!prefersReduced){
      inner.classList.toggle('is-flipped', next);
      if(next){
        const back = card.querySelector('.flip-back');
        back && back.focus({preventScroll:true});
      }
    }
  }

  // Click
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.flip-toggle');
    if (btn) { e.preventDefault(); toggleCard(btn); }
  });

  // Keyboard (Enter/Space on the button)
  document.addEventListener('keydown', (e) => {
    const btn = e.target.closest('.flip-toggle');
    if (!btn) return;
    if (e.key === ' ' || e.key === 'Enter'){
      e.preventDefault();
      toggleCard(btn);
    }
  });
})();
</script>

<!-- Awareness: cascading dropdowns + lazy import -->
<script type="module">
(function(){
  const root = document.getElementById('awareness');
  if(!root) return;

  const groupSel = root.querySelector('#sourceFilter');
  const vizSel   = root.querySelector('#vizFilter');
  const blocks   = [...root.querySelectorAll('.viz-block')];

  const index = blocks.reduce((acc, el) => {
    const g = el.dataset.group, k = el.dataset.key, label = el.dataset.label || k;
    (acc[g] ||= []).push({ key:k, label });
    return acc;
  }, {});
  Object.values(index).forEach(list => list.sort((a,b)=>a.label.localeCompare(b.label)));

  function populateVizOptions(group){
    const list = index[group] || [];
    vizSel.innerHTML = list.map(({key,label}) =>
      `<option value="${key}">${label}</option>`).join('');
  }

  function show(group, key){
    blocks.forEach(el => {
      const on = el.dataset.group === group && el.dataset.key === key;
      el.classList.toggle('is-active', on);
    });
  }

  // promise-based lazy import, then (re)draw current visible charts
  let loaded = false, loading = null;
  function ensureAwareness(){
    if (loaded) return loading || Promise.resolve();
    loading = import("{% static 'js/awareness.js' %}")
      .then(() => { loaded = true; window.initAwarenessCharts && window.initAwarenessCharts(); })
      .catch(console.error);
    return loading;
  }

  // Initial state
  populateVizOptions(groupSel.value);
  show(groupSel.value, vizSel.value);
  ensureAwareness();

  // Load when visible (first time)
  if ('IntersectionObserver' in window){
    const io = new IntersectionObserver((entries)=>{
      entries.forEach(e => { if (e.isIntersecting){ ensureAwareness(); io.disconnect(); }});
    }, { rootMargin: "120px" });
    io.observe(root);
  }

  // Events (call ensureAwareness() THEN draw)
  groupSel.addEventListener('change', ()=>{
    populateVizOptions(groupSel.value);
    show(groupSel.value, vizSel.value);
    ensureAwareness().then(()=>window.initAwarenessCharts && window.initAwarenessCharts());
  });

  vizSel.addEventListener('change', ()=>{
    show(groupSel.value, vizSel.value);
    ensureAwareness().then(()=>window.initAwarenessCharts && window.initAwarenessCharts());
  });
})();
</script>

{% endblock %}
